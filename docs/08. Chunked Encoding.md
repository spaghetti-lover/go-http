# Chunked Encoding

## What

- Chunked Transfer Encoding is mechanism allow server to **send data in chunk**
- Format of one chunk

  ```php-template
  <chunk-size-hex>\r\n
  <chunk-data>\r\n
  ```

- End when meet (when meet chunk size = 0)

  ```bash
  0\r\n
  \r\n
  ```

## Why

- Can not know data size before hand:

  - Streaming large file
  - Live update (chat, logs, SSE-like)
  - Receive data in chunk from other API

- Real-time processing
- Reduce latency: No need to buffer all data

## How

1. Server send header: `Transfer-Encoding: chunked`.
2. Each time server has data, server send for example:

```
1E
I could go for a cup of coffee
```

3. After last chunk, sever send:

```
0\r\n
\r\n
``
```

### Implementation

- Check commit
- Test:

  ```
  # Start the server
  go run ./cmd/httpserver

  # Test with netcat to see raw chunked response
  echo -e "GET /httpbin/stream/3 HTTP/1.1\r\nHost: localhost:42069\r\nConnection: close\r\n\r\n" | nc localhost 42069

  # Or test with curl (it will decode chunks automatically)
  curl -v http://localhost:42069/httpbin/stream/3

  # Test regular endpoints still work
  curl http://localhost:42069/
  curl http://localhost:42069/yourproblem
  curl http://localhost:42069/myproblem
  ```

- The netcat command will show you the raw chunked response with hex chunk sizes like:

  ```bash
  HTTP/1.1 200 OK
  Transfer-Encoding: chunked
  Connection: close
  ...

    3A
    {"url": "https://httpbin.org/stream/3", ...}
    3B
    {"url": "https://httpbin.org/stream/3", ...}
    0

  ```

# Trailers

## What

- Trailers is HTTP headers is sent after body when server use `Transfer-Encoding: chunked`
- For example:
  Trailer: Lane, Prime, TJ

  ```mathematica
  1E
  I could go for a cup of coffee
  C
  But not Java
  0

  Lane: goober
  Prime: chill-guy
  TJ: 1-indexer

  ```

## Why

Sometime server does not know value of some header when sending response in advanced like: total of body bytes, hash of entire body, metadata after reading data,...

## How

1. Sending headers with these fields:

- `Transfer-Encoding: chunked`
- `Trailer:..`

2. Send in each chunk:

```php-template
<chunk-size>\r\n
<chunk-data>\r\n
```

3. Send empty chunk (end of body): `0\r\n`
4. Send pre-defined trailer:

```yaml
X-Hash: abcdef23
X-Length: 5000
\r\n
```

### Implementation

- Check commit
- Test

```bash
# Start your server
go run ./cmd/httpserver

# In another terminal, test with curl --raw to see the raw response
curl --raw http://localhost:42069/httpbin/get

# You should see something like:
# HTTP/1.1 200 OK
# ...headers...
# Transfer-Encoding: chunked
# Trailer: X-Content-SHA256, X-Content-Length
#
# ...chunked body...
# 0
# X-Content-SHA256: <hash>
# X-Content-Length: <length>
```
